(()=>{"use strict";function t(){return localStorage.getItem("r2_twitch_user_markers_v2_token")}const e=(e,r)=>{const a=t();return fetch("https://vum.rascaltwo.com/api"+e,{...r||{},headers:{...a?{Authorization:`Bearer ${a}`}:{},...r?.headers||{}}}).then((t=>t.json())).catch((t=>{throw console.error(t),t}))};async function r(){return t()?e("/user").catch((()=>null)):null}async function a(t,r){return e("/collections/"+t+"/"+r).catch((()=>[]))}async function n(t){return e("/collection/"+t).catch((()=>{}))}class i{cache;constructor(){this.cache=new Map}clear(){this.cache.clear()}}let s=0;function o(){return s}async function l(t,e,r,a){return new Promise((n=>{s++;let i=!1;const o=document.createElement("form");o.id="r2_dialog",o.style.position="absolute",o.style.zIndex=(9e3+s).toString(),o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.padding="1em",o.style.borderRadius="1em",g(o.style),o.style.display="flex",o.style.flexDirection="column",o.style.gap="1rem",o.innerHTML=r;const l=t=>{t?.preventDefault();const e=i?null:c(o);return o.remove(),s--,w(),n(e)};o.addEventListener("submit",l);const[c,d,u,m]={alert:()=>[()=>!0,()=>o.querySelector('button[type="submit"]').focus(),p,a],prompt:()=>{const[t,e]=a?.(o)??["input",""],r=document.createElement(t);return r.value=e,"textarea"===t&&r.setAttribute("rows",10),r.addEventListener("keydown",(t=>"Enter"===t.key&&t.ctrlKey?l():void 0)),o.appendChild(r),[()=>r.value.trim(),()=>r.focus(),()=>{const t=r.value.split("\n"),e=Math.max(...t.map((t=>t.length)));e&&(r.style.width=Math.max(r.offsetWidth,e*function(){const t=document.createElement("div");t.style.position="absolute",t.textContent="M",document.body.appendChild(t);const e=t.offsetWidth;return t.remove(),e}())+"px")},p]},choose:()=>(o.appendChild(Object.entries(a(o)).reduce(((e,[r,a])=>{const n=document.createElement("button");return n.className=t,n.style.width="auto",n.textContent=r,n.value=JSON.stringify(a),n.addEventListener("click",(()=>o.dataset.value=n.value)),o.dataset.value=JSON.stringify(null),e.appendChild(n),e}),document.createDocumentFragment())),[()=>JSON.parse(o.dataset.value),()=>{o.querySelector('button[type="submit"]').remove(),o.querySelector("button").focus()},p,p])}[e](),h=document.createElement("div");h.style.flex="1",h.style.display="flex",h.style.gap="1rem";const y=document.createElement("button");y.className=t,y.style.width="auto",y.style.flex="1",y.textContent="OK",y.type="submit",h.appendChild(y);const f=document.createElement("button");f.className=t,f.style.width="auto",f.style.flex="1",f.textContent="Cancel",f.addEventListener("click",(()=>i=!0)),h.appendChild(f),o.appendChild(h),document.body.appendChild(o);const w=b(l,(()=>o.style.zIndex===(9e3+s).toString()));setTimeout((()=>{d(o),m?.(o),u(o)}))}))}const c={"client-id":"kimne78kx3ncx6brgo4mv6wki5h1ko"};class d extends i{static TOP_BAR_SELECTOR='[class="channel-info-content"] [class*="metadata-layout__"]';cachedDelay;name;constructor(){super(),this.cachedDelay=[0,0],this.name="Twitch"}async createInitialCollection(t,e){const r=(new Date).toISOString();return{_id:E(),entity:{_id:await this.getEntityID(),type:this.name,thumbnail:"",createdAt:r},author:e,title:document.title,description:"",markers:t,createdAt:r,updatedAt:r}}dialog(t,e,r){return l(this.getButtonClass(),t,e,r)}getButtonClass(){return document.querySelector('[data-a-target="top-nav-get-bits-button"]')?.className??document.querySelector('[data-a-target="login-button"]')?.className??""}isLive(){const t=window.location.pathname.split("/").slice(1);return("videos"!==t[0]||2!==t.length)&&!!document.querySelector(".user-avatar-card__live")}getLoginName(){return this.isLive()?window.location.pathname.split("/")[1]:new URLSearchParams(document.querySelector('meta[property="og:video"]').getAttribute("content").split("?").slice(1).join("?")).get("channel")}async getUserID(){return this.cache.has("userID")?this.cache.get("userID"):fetch("https://gql.twitch.tv/gql",{headers:c,body:`{"query":"query($login: String!, $skip: Boolean!) {\\n\\t\\t\\t\\tuser(login: $login) {\\n\\t\\t\\t\\t\\tbroadcastSettings {\\n\\t\\t\\t\\t\\t\\tlanguage\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\tcreatedAt\\n\\t\\t\\t\\t\\tdescription\\n\\t\\t\\t\\t\\tdisplayName\\n\\t\\t\\t\\t\\tfollowers {\\n\\t\\t\\t\\t\\t\\ttotalCount\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\tid\\n\\t\\t\\t\\t\\tlastBroadcast {\\n\\t\\t\\t\\t\\t\\tstartedAt\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\tprimaryTeam {\\n\\t\\t\\t\\t\\t\\tdisplayName\\n\\t\\t\\t\\t\\t\\tname\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\tprofileImageURL(width: 70)\\n\\t\\t\\t\\t\\tprofileViewCount\\n\\t\\t\\t\\t\\tself @skip(if: $skip) {\\n\\t\\t\\t\\t\\t\\tcanFollow\\n\\t\\t\\t\\t\\t\\tfollower {\\n\\t\\t\\t\\t\\t\\t\\tdisableNotifications\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t}\\n\\t\\t\\t}","variables":{"login":"${this.getLoginName()}","skip":false}}`,method:"POST"}).then((t=>t.json())).then((t=>{const e=t.data.user.id;return this.cache.set("userID",e),m("GQL User ID:",e),e}))}isVOD(){return window.location.pathname.startsWith("/videos")}shouldActivate(){return this.isVOD()||this.isLive()}async getEntityID(){return this.isVOD()?window.location.href.split("/").slice(-1)[0].split("?")[0]:this.cache.has("vid")?this.cache.get("vid"):this.getUserID().then((t=>fetch("https://gql.twitch.tv/gql",{headers:c,body:`{"query":"query($id: ID!, $all: Boolean!) {\\n\\t\\t\\t\\t\\tuser(id: $id) {\\n\\t\\t\\t\\t\\t\\tbroadcastSettings {\\n\\t\\t\\t\\t\\t\\t\\tgame {\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplayName\\n\\t\\t\\t\\t\\t\\t\\t\\tname\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\t\\ttitle\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tlogin\\n\\t\\t\\t\\t\\t\\tstream {\\n\\t\\t\\t\\t\\t\\t\\tarchiveVideo @include(if: $all) {\\n\\t\\t\\t\\t\\t\\t\\t\\tid\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\t\\tcreatedAt\\n\\t\\t\\t\\t\\t\\t\\tid\\n\\t\\t\\t\\t\\t\\t\\ttype\\n\\t\\t\\t\\t\\t\\t\\tviewersCount\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t}","variables":{"id":"${t}","all":true}}`,method:"POST"}))).then((t=>t.json())).then((t=>{const e=t.data.user.stream.archiveVideo?.id??t.data.user.stream.id;return this.cache.set("vid",e),m("GQL VOD ID:",e),e}))}async isReady(){return document.querySelector('.video-ref [data-a-target="player-volume-slider"]')?document.querySelector(d.TOP_BAR_SELECTOR)?document.querySelector('.video-ref [data-a-target="video-ad-countdown"]')?(m("Waiting for Advertisement..."),await f(5e3),!1):!!this.isLive()||!(!this.isVOD()||!document.querySelector(".video-ref .seekbar-bar"))||(m("Waiting for player..."),!1):(m("Waiting for Video Info Bar..."),!1):(m("Waiting for Volume..."),!1)}async attachMenu(t){document.querySelector(d.TOP_BAR_SELECTOR+" > div:last-of-type").appendChild(t)}getTimeXY(t){const e=document.querySelector(".video-ref .seekbar-bar").getBoundingClientRect(),r=e.left,a=e.right;return{x:(a-r)*(t/Number(document.querySelector('.video-ref [data-a-target="player-seekbar-duration"]').dataset.aValue)),y:(e.bottom+e.top)/2,minX:r,maxX:a}}async seekTo(t){const e=document.querySelector('.video-ref [data-a-target="player-seekbar"]');Object.entries(e.parentNode).find((([t])=>t.startsWith("__reactEventHandlers")))[1].children[2].props.onThumbLocationChange(t)}removeDOMMarkers(){document.querySelectorAll(".video-ref .r2_marker").forEach((t=>t.remove()))}async*generateMarkerChangeHandlers(t,e,r){this.isVOD()&&(yield()=>{this.removeDOMMarkers();const a=document.querySelector(".video-ref .seekbar-bar");for(const n of t.markers){const t=document.createElement("button");t.className="r2_marker",t.title=n.title,t.style.position="absolute",t.style.width="1.75px",t.style.height="10px",g(t.style),t.style.left=this.getTimeXY(n.when).x+"px",t.addEventListener("click",e.bind(null,n)),t.addEventListener("contextmenu",r.bind(null,n,!0,!0)),a.appendChild(t)}})}async*generateUniqueAttachments(t,e,r){yield(()=>{const r=document.createElement("a");r.href="#",r.style.cursor="hover",r.style.paddingLeft="1em",r.className="r2_current_marker",r.dataset.controlled="",this.isVOD()&&(r.style.cursor="pointer",r.addEventListener("click",(t=>{t.preventDefault(),this.seekTo(Number(r.dataset.seconds))}))),r.addEventListener("contextmenu",(t=>{t.preventDefault(),e.setMarkerList(!0)})),document.querySelector('.video-ref [data-a-target="player-volume-slider"]').parentNode.parentNode.parentNode.parentNode.appendChild(r);const a=setInterval((async()=>{if(r.dataset.controlled)return;let e;if(this.isVOD()){if(document.querySelector('.video-ref [data-a-target="video-ad-countdown"]'))return;const r=await this.getCurrentTimeLive();e=t.markers.filter((t=>Math.floor(t.when)<=r)).slice(-1)[0]}else e=t.markers[t.markers.length-1];e||(e={title:"",when:-1}),r.textContent=e.title,r.dataset.seconds=e.when.toString()}),1e3);return()=>{clearInterval(a),r.remove()}})(),yield(()=>{const t=new ResizeObserver((()=>r(!1)));return t.observe(document.querySelector(".video-ref video")),()=>t.unobserve(document.querySelector(".video-ref video"))})(),this.isVOD()&&(yield(()=>{const e=e=>{if(e.target===a)return;const r=document.querySelector(".video-ref .r2_current_marker");r.dataset.controlled="true";const n=(t=>{const e=t/a.getBoundingClientRect().width;return Number(document.querySelector('.video-ref [data-a-target="player-seekbar-duration"]').dataset.aValue)*e})(e.layerX),i=t.markers.filter((t=>Math.floor(t.when)<=n)).slice(-1)[0]??null;i&&r.dataset.seconds!==i.when.toString()&&(r.textContent=i.title,r.dataset.seconds=i.when.toString())},r=()=>{document.querySelector(".video-ref .r2_current_marker").dataset.controlled=""},a=document.querySelector(".video-ref .seekbar-bar").parentNode;return a.addEventListener("mouseover",e),a.addEventListener("mouseleave",r),()=>{a.removeEventListener("mouseover",e),a.removeEventListener("mouseleave",r)}})(),yield(()=>{const t=async t=>{t.preventDefault();const e=Math.min(Math.max(t.deltaY,-1),1);await this.seekTo(await this.getCurrentTimeLive()+e)},e=document.querySelector(".video-ref .seekbar-bar").parentNode;return e.addEventListener("wheel",t),()=>{e.removeEventListener("wheel",t)}})(),yield this.removeDOMMarkers)}async getLiveDelay(){const t=Date.now();if(t-this.cachedDelay[0]<6e4)return Promise.resolve(this.cachedDelay[1]);const e=document.querySelector('.video-ref [aria-label="Latency To Broadcaster"]'),r=document.querySelector('.video-ref [aria-label="Buffer Size"]');if(!e||!r)return await w('[data-a-target="player-settings-button"]','[data-a-target="player-settings-menu-item-advanced"]','[data-a-target="player-settings-submenu-advanced-video-stats"] input'),this.getLiveDelay();w('[data-a-target="player-settings-submenu-advanced-video-stats"] input','[data-a-target="player-settings-button"]');const a=[e,r].map((t=>Number(t.textContent.split(" ")[0]))).reduce(((t,e)=>t+e));return this.cachedDelay=[t,a],a}async getCurrentTimeLive(){if(this.isVOD())return v(document.querySelector('.video-ref [data-a-target="player-seekbar-current-time"]').textContent.split(":").map(Number));const{delay:t,response:e}=await async function(t){const e=Date.now(),r=await t();return{delay:Date.now()-e,response:r}}((async()=>this.getLiveDelay()));return v(document.querySelector(".live-time").textContent.split(":").map(Number))-e-t/1e3}async generateMarkerURL(t){return`https://twitch.tv/videos/${await this.getEntityID()}?t=${function(t){const e=["d","h","m"],r=Array.from(k(t));for(;;){const t=r.lastIndexOf(":");if(-1===t)break;r[t]=e.pop()}return r.join("")+"s"}(t)}`}async getCollections(){const t=await this.createInitialCollection([],null);return[...t.markers.length?[t]:[],...await a(this.name,await this.getEntityID())]}async play(){await w('[data-a-target="player-play-pause-button"]')}async pause(){await w('[data-a-target="player-play-pause-button"]')}async isPlaying(){return console.log(document.querySelector('[data-a-target="player-play-pause-button"]').dataset.aPlayerState),"playing"===document.querySelector('[data-a-target="player-play-pause-button"]').dataset.aPlayerState}}class u extends i{name;initialCollection;constructor(){super(),this.name="YouTube",this.initialCollection=void 0}async createInitialCollection(t,e){if(this.initialCollection)return this.initialCollection;const r=(new Date).toISOString(),a=E();let n;try{n=new Date(document.querySelector("#info-container yt-formatted-string").get("__data").text.runs[2].text).toISOString()}catch(t){}const i=this.getYTPlayerElement(),s=await this.getEntityID(),o=i.dataset.r2InitialCollectionID===s&&i.dataset.r2InitialCollection,l=o?JSON.parse(i.dataset.r2InitialCollection):{_id:a,entity:{_id:s,type:this.name,thumbnail:`https://img.youtube.com/vi/${s}/maxresdefault.jpg`,rawThumbnail:`https://img.youtube.com/vi/${s}/maxresdefault.jpg`,createdAt:n},author:{_id:"WEBSITE",username:"YouTube Video Author"},title:i.getPlayer().getVideoData().title,description:"",markers:this.getDescriptionChaptersMarkerMap(i.get("watchNextData"))?.chapters.map((t=>({_id:E(),collectionRef:a,when:t.chapterRenderer.timeRangeStartMillis/1e3,title:t.chapterRenderer.title.simpleText,description:""})))??[],createdAt:r,updatedAt:r};return this.initialCollection=l.markers.length?l:null,this.initialCollection&&!o&&(i.dataset.r2InitialCollectionID=s,i.dataset.r2InitialCollection=JSON.stringify(this.initialCollection)),t.length?{_id:a,entity:{_id:s,type:this.name,thumbnail:`https://img.youtube.com/vi/${s}/maxresdefault.jpg`,createdAt:new Date(document.querySelector("#info-container yt-formatted-string").get("__data").text.runs[2].text).toISOString()},author:e,title:i.getPlayer().getVideoData().title,description:"",markers:t,createdAt:r,updatedAt:r}:l}dialog(t,e,r){return l(this.getButtonClass(),t,e,r)}getButtonClass(){return document.querySelector("#flexible-item-buttons button").className}isLive(){return!!this.getYTPlayerElement()?.getPlayer().getVideoData().isLive}shouldActivate(){return window.location.pathname.startsWith("/watch")}getYTPlayerElement(){return document.querySelector("#ytd-player")}getDescriptionChaptersMarkerMap(t){return t?.playerOverlays.playerOverlayRenderer.decoratedPlayerBarRenderer?.decoratedPlayerBarRenderer.playerBar.multiMarkersPlayerBarRenderer.markersMap?.find((t=>"DESCRIPTION_CHAPTERS"===t.key))?.value}async isReady(){return!!this.getYTPlayerElement()?.getPlayer()}async attachMenu(t){const e=document.querySelector("#subscribe-button");e.parentElement?.insertBefore(t,e.nextSibling)}async seekTo(t){this.getYTPlayerElement()?.getPlayer().seekTo(t)}async*generateUniqueAttachments(){}async*generateMarkerChangeHandlers(t){yield()=>{const e=JSON.parse(JSON.stringify(this.getYTPlayerElement().get("watchNextData")));let r=this.getDescriptionChaptersMarkerMap(e);if(!r){const t={decoratedPlayerBarRenderer:{playerBar:{multiMarkersPlayerBarRenderer:{markersMap:[{key:"DESCRIPTION_CHAPTERS",value:{chapters:[],trackingParams:""}},...e.playerOverlays.playerOverlayRenderer.decoratedPlayerBarRenderer?.decoratedPlayerBarRenderer.playerBar.multiMarkersPlayerBarRenderer.markersMap?.filter((t=>"DESCRIPTION_CHAPTERS"!==t.key))||[]],visibleOnLoad:{key:"DESCRIPTION_CHAPTERS"}}}}};e.playerOverlays.playerOverlayRenderer.decoratedPlayerBarRenderer=t,r=this.getDescriptionChaptersMarkerMap(e)}const a=r.chapters,n=r.trackingParams;a.splice(0,a.length);const i=t.markers.map(((t,e)=>({chapterRenderer:{onActiveCommand:{clickTrackingParams:n,setActivePanelItemAction:{itemIndex:e,panelTargetId:"engagement-panel-macro-markers-description-chapters"}},timeRangeStartMillis:Math.floor(1e3*t.when),title:{simpleText:t.title}}})));a.push(...i.slice(0,-1)),0===i.length&&a.push({chapterRenderer:{onActiveCommand:{clickTrackingParams:n,setActivePanelItemAction:{itemIndex:0,panelTargetId:"engagement-panel-macro-markers-description-chapters"}},timeRangeStartMillis:0,title:{simpleText:" "}}}),1===i.length&&a.push({chapterRenderer:{onActiveCommand:{clickTrackingParams:n,setActivePanelItemAction:{itemIndex:1,panelTargetId:"engagement-panel-macro-markers-description-chapters"}},timeRangeStartMillis:1e3,title:{simpleText:" "}}}),this.getYTPlayerElement().set("watchNextData",e),i.length&&setTimeout((()=>{const t=JSON.parse(JSON.stringify(this.getYTPlayerElement().get("watchNextData")));this.getDescriptionChaptersMarkerMap(t).chapters.push(i.at(-1)),this.getYTPlayerElement().set("watchNextData",t)}),100)}}async getCurrentTimeLive(){return this.getYTPlayerElement().getPlayer().getCurrentTime()}async generateMarkerURL(t){return`https://youtu.be/${await this.getEntityID()}?t=${t}`}async getEntityID(){if(this.cache.has("entityID"))return this.cache.get("entityID");const t=this.getYTPlayerElement().getPlayer().getVideoData().video_id;return this.cache.set("entityID",t),t}async getCollections(){return await this.createInitialCollection([],null),[...this.initialCollection?[this.initialCollection]:[],...await a(this.name,await this.getEntityID())]}async play(){return this.getYTPlayerElement().getPlayer().playVideo()}async pause(){return this.getYTPlayerElement().getPlayer().pauseVideo()}async isPlaying(){return 1===this.getYTPlayerElement().getPlayer().getPlayerState()}}function m(...t){console.log("[R2 Video User Markers]",...t)}const h=t=>navigator.clipboard.writeText(t).then((()=>{window.r2_clipboard=t}));function p(){}function y(){return window.matchMedia("(prefers-color-scheme: dark)").matches}function g(t,e=y()){Object.assign(t,e?{backgroundColor:"#18181b",color:"white"}:{backgroundColor:"white",color:"#18181b"})}function f(t){return new Promise((e=>setTimeout(e,t)))}async function w(...t){for(const e of t)for(;;){const t=document.querySelector(e);if(t){t.click();break}await f(100)}}function v(t){return 1===t.length?t[0]:2===t.length?60*t[0]+t[1]:3===t.length?60*t[0]*60+60*t[1]+t[2]:60*t[0]*60*24+60*t[1]*60+60*t[2]+t[3]}function k(t,e=1){const r=Math.floor(t/86400),a=[r,Math.floor((t-86400*r)/3600),Math.floor(t%3600/60),Math.floor(t%60)];for(;!a[0]&&a.length>e;)a.shift();return a.map((t=>t.toString().padStart(2,"0"))).join(":")}function b(t,e=(()=>!0)){const r=a=>{if("Escape"===a.key&&e())return a.preventDefault(),a.stopImmediatePropagation(),a.stopPropagation(),window.removeEventListener("keydown",r),t()};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)}async function S(t){return JSON.parse(localStorage.getItem("r2_twitch_user_markers_v2_"+t)??JSON.stringify({formatter:"json",rawMarkers:"[]",updatedAt:(new Date).toISOString()}))}const C=t=>Math.floor(t).toString(16),E=(t=Date.now())=>C(t/1e3)+" ".repeat(16).replace(/./g,(()=>C(16*Math.random())));class _{static multiline=!1;static delim="\n";static*serialize(t){return[]}static*deserialize(t){return[]}static serializeAll(t){return Array.from(this.serialize(t)).join(this.delim)}static deserializeAll(t){return Array.from(this.deserialize(t))}static serializeSeconds(t){return t}static deserializeSeconds(t){return Number(t)}static serializeName(t){return t}static deserializeName(t){return t}}const x={json:class extends _{static serializeAll(t){return console.log("ser json",t),JSON.stringify(t)}static deserializeAll(t){return JSON.parse(t)}},minimal:class extends _{static delim="\n";static*serialize(t){const e=k(t[t.length-1]?.when??0).split(":").length;for(const r of t){const t=k(r.when,e);yield[t,r.title,r.description].filter(Boolean).join("\t")}}static*deserialize(t){for(const e of t.trim().split("\n").map((t=>t.trim())).filter(Boolean)){let[t,r,a]=e.split(/\t| {2}/g);if(!r){let a=[];[t,...a]=e.split(" "),r=a.join(" ")}r||(r="Untitled");const n=v(t.split(":").map(Number));yield{_id:E(),collectionRef:E(),title:r,when:n,description:a}}}static deserializeAll(t){return Array.from(this.deserialize(t))}static serializeSeconds(t){return k(t)}static deserializeSeconds(t){return v(t.split(":").map(Number))}}};function L(){return x[localStorage.getItem("r2_twitch_user_markers_ui_formatter_v2")??"minimal"]}m("Script Started"),async function t(){await(window.r2_twitch_user_markers?.uninstall()),m("Setup Started");const a="www.twitch.tv"===window.location.hostname?new d:"www.youtube.com"===window.location.hostname?new u:null;if(!a)return m("Unsupported platform"),p;for(m("Platform:",a.name);"complete"!==document.readyState;)await f(1e3),m("Waiting for complete document...");const{addUninstallationStep:i,uninstall:l}=function(t,e){const r=[function(e=(()=>!1)){const r=window.location.href,n=setInterval((()=>{(e()||((t,e,...r)=>{const a=new URLSearchParams(t.split("?")[1]),n=new URLSearchParams(e.split("?")[1]);for(const t of r)a.delete(t),n.delete(t);return t.split("?")[0]!==e.split("?")[0]||a.toString()!==n.toString()})(window.location.href,r,"index","list"))&&(clearInterval(n),a().then(t))}),1e3);return()=>clearInterval(n)}(e)];async function a(){m("Uninstalling...");for(const t of r)await t();m("Uninstalled")}return window.r2_twitch_user_markers={uninstall:a},{addUninstallationStep:function(t){r.push(t)},uninstall:a}}(t,a.shouldActivate()?void 0:a.shouldActivate.bind(a));if(i(a.clear.bind(a)),!a.shouldActivate())return void m("Not Activating");for(;await f(1e3),!await a.isReady(););let c=await r(),w=await a.getCollections(),{collection:v,updatedAt:C}=await(async()=>{const{formatter:t,rawMarkers:e,collection:r,updatedAt:i}=await S(await a.getEntityID());if(!(t in x))return a.dialog("alert",`Formatter for saved content does not exist: ${t}`),{collection:null,updatedAt:""};const s=x[t].deserializeAll(e||"[]");if(r)return r.markers?.length||(r.markers=s),{collection:r,updatedAt:i};const o=w.find((t=>"WEBSITE"!==t.author._id));if(o){const t=await n(o._id);return{collection:t,updatedAt:t.updatedAt}}const l=await a.createInitialCollection(s,c);return{collection:l,updatedAt:l.createdAt}})();const _=v;if(null===_)return void m("Error loading markers, abandoning");function I(){const t=document.querySelector(".r2_markers_ui")?.querySelector("summary");if(!t)return;const e=_.updatedAt!==C,r=(w.filter((t=>"WEBSITE"!==t.author._id&&t.author._id!==c?._id)).length||"")+(e?"*":""),a=t.querySelector("span");a.textContent=r,a.style.display=r?"inline":"none",a.title=e?"Unsaved Local Changes":""}i(await(async()=>{const t=document.createElement("details");t.className="r2_markers_ui",t.style.margin="0.5em",t.style.padding="0.5em";const e=document.createElement("summary");e.style.listStyle="none",e.style.textAlign="center",e.style.cursor="pointer",e.style.display="flex",e.style.justifyContent="center";const r=document.createElement("div");r.style.position="relative",r.style.width="max-content";const n=document.createElement("img");n.src="https://vum.rascaltwo.com/favicon.svg",r.appendChild(n);const i=document.createElement("span");i.style.position="absolute",i.style.top="0",i.style.right="0",i.style.backgroundColor="red",i.style.borderRadius="50%",i.style.width="1em",i.style.height="1em",i.style.lineHeight="1em",i.style.textAlign="center",i.style.color="white",i.style.fontSize="0.5em",i.style.fontWeight="bold",r.appendChild(i),e.appendChild(r),t.appendChild(e);const s=document.createElement("div");s.style.display="flex",s.style.gap="0.5em",t.appendChild(s);const o=document.createElement("button");o.textContent="Menu",o.className=a.getButtonClass(),o.style.width="auto",o.style.flex="1",o.addEventListener("click",(()=>z())),s.appendChild(o);const l=document.createElement("button");return l.textContent="Add",l.className=a.getButtonClass(),o.style.width="auto",l.style.flex="1",l.addEventListener("click",(()=>B())),s.appendChild(l),await a.attachMenu(t),I(),()=>t.remove()})());const{startEditingMarker:T,editAllMarkers:A}=function(t,e,r){return{startEditingMarker:function(e,a,n,i){return i?.preventDefault(),i?.stopImmediatePropagation(),i?.stopPropagation(),a&&n?async function(e){const a=L(),n=await t.dialog("prompt","Edit Marker:",(()=>[a.multiline?"textarea":"input",a.serializeAll([e])[0]]));if(null===n)return;const i=a.deserializeAll(n)[0];return i?(Object.assign(e,i,{_id:e._id,collectionRef:e.collectionRef}),r(!0)):void 0}(e):a?async function(e){const a=L(),n=await t.dialog("prompt","Edit Time:",(()=>[a.multiline?"textarea":"input",a.serializeSeconds(e.when)]));if(null===n)return;const i=a.deserializeSeconds(n);return i?(e.when=i,r(!0)):void 0}(e):async function(e){const a=L(),n=await t.dialog("prompt","Edit Name:",(()=>[a.multiline?"textarea":"input",a.serializeName(e.title)]));if(null===n)return;const i=a.deserializeName(n);return i?(e.title=i,r(!0)):void 0}(e)},editAllMarkers:async function(){const a=L(),n=await t.dialog("prompt","Edit Serialized Markers",(()=>["textarea",a.serializeAll(e.markers)]));if(null!==n)return e.markers.splice(0,e.markers.length,...a.deserializeAll(n).map(((t,r)=>({...t,_id:e.markers[r]?._id||E(),collectionRef:e.markers[r]?.collectionRef||e._id})))),r(!0)}}}(a,_,N);let M=[t=>{t&&(C=(new Date).toISOString())},async()=>{const t=await a.getEntityID();return S(t).then((({formatter:e})=>async function(t,e,{markers:r,...a},n){localStorage.setItem("r2_twitch_user_markers_v2_"+t,JSON.stringify({formatter:e,rawMarkers:x[e].serializeAll(r),collection:a,updatedAt:n}))}(t,e,_,C)))},I];function D(t,e){return e?.stopImmediatePropagation(),e?.stopPropagation(),a.seekTo(t.when)}const P=((t,e,r,a,n,i,l)=>{function c(e){const r=t.markers.findIndex((t=>t.when===e.when));return t.markers.splice(r,1),a(!0)}function d(t,e){return t.when+=e,a(!0).then((()=>t))}let u=!1,m={x:0,y:0,top:window.innerHeight/10,left:window.innerWidth/10};const h=[],p=[],w=e=>r().then((r=>e.querySelectorAll("li")[(t.markers.map(((t,e)=>[t,e])).filter((([t])=>Math.floor(t.when)<=r)).slice(-1)[0]??[null,-1])[1]]));function v(){if(!u)return S();p.push(function(){if(document.querySelector(".r2_marker_list_style"))return()=>{};const t=document.createElement("style");return t.className="r2_marker_list_style",t.appendChild(document.createTextNode("\n\t\t/* Scrollbar Styles */\n\t\t.r2_marker_list::-webkit-scrollbar {\n\t\t\twidth: 7.5px;\n\t\t}\n\n\t\t.r2_marker_list::-webkit-scrollbar-track {\n\t\t\tbackground: transparent;\n\t\t}\n\n\t\t.r2_marker_list::-webkit-scrollbar-thumb {\n\t\t\tbackground-color: rgb(24, 24, 27);\n\t\t\tborder-radius: 7px;\n\t\t\tborder: 1px solid rgb(239, 239, 241);\n\t\t}\n\n\t\t/* Resizing Styles */\n\t\t.r2_marker_list::-webkit-resizer {\n\t\t\tborder: 3px solid white;\n\t\t\tbackground: transparent;\n\t\t\tcursor: nwse-resize;\n\t\t}\n\t")),document.querySelector("head").appendChild(t),()=>t.remove()}());const r=document.querySelector(".r2_marker_list"),a=r||document.createElement("ul");if(!r){a.className="r2_marker_list",a.style.position="absolute",a.style.zIndex=(9e3+o()).toString(),a.style.padding="1em",a.style.borderRadius="1em",a.style.display="flex",a.style.gap="0.5em",a.style.flexDirection="column",a.style.maxHeight="75vh",a.style.maxWidth="50vw",a.style.overflow="scroll",a.style.overflowX="auto",a.style.resize="both",g(a.style),a.style.top=m.top+"px",a.style.left=m.left+"px";const t=document.createElement("h4");t.textContent="Marker List",t.style.userSelect="none",t.style.padding="0",t.style.margin="0",g(t.style);let r=!1;a.addEventListener("mousedown",(t=>{Math.abs(a.offsetLeft-t.clientX)>=a.offsetWidth/10*9&&Math.abs(a.offsetTop-t.clientY)>=a.offsetHeight/10*9||(r=!0,m.x=t.clientX,m.y=t.clientY)}));const n=()=>{r=!1};document.body.addEventListener("mouseup",n);const i=t=>{r&&(a.style.top=a.offsetTop-(m.y-t.clientY)+"px",a.style.left=a.offsetLeft-(m.x-t.clientX)+"px",m.x=t.clientX,m.y=t.clientY,m.top=parseInt(a.style.top),m.left=parseInt(a.style.left))};document.body.addEventListener("mousemove",i),a.appendChild(t),p.push((()=>{document.body.removeEventListener("mousemove",i),document.body.removeEventListener("mouseup",n)}));const s=document.createElement("button");s.className=e.getButtonClass(),s.style.width="auto",s.style.float="right",s.textContent="Close",s.addEventListener("click",(()=>C(!1))),t.appendChild(s),p.push(b((()=>C(!1)),(()=>a.style.zIndex===(9e3+o()).toString())))}t.markers.sort(((t,e)=>t.when-e.when));const s=k(t.markers[t.markers.length-1]?.when??0).split(":").length;function h(e){const r=e.target.closest("[data-id]").dataset.id;return t.markers.find((t=>t._id===r))}const v=(t,r=!0)=>{if(a.querySelectorAll('li[data-r2_active_marker="true"]').forEach((t=>{delete t.dataset.r2_active_marker,t.style.outline=""})),t.dataset.r2_active_marker="true",t.style.outline="1px dashed "+(y()?"white":"black"),t.scrollIntoView({block:"nearest",inline:"nearest"}),r&&!e.isLive())return n(h({target:t}).when)};for(const[r,o]of t.markers.entries()){const t=a.querySelectorAll("li")[r],u=t||document.createElement("li");u.dataset.id=o._id,t||(u.style.display="flex",u.style.gap="1em",u.style.alignItems="center");const m=k(o.when,s),p=u.querySelector("span")||document.createElement("span");if(t)p.childNodes[1].textContent=m;else{p.style.fontFamily="monospace",p.addEventListener("wheel",(t=>(v(u),t.preventDefault(),d(h(t),Math.min(Math.max(t.deltaY,-1),1)).then((t=>e.isLive()?void 0:n(t.when))))));const t=document.createElement("button");t.className=e.getButtonClass(),t.style.width="auto",t.style.display="inline-block",t.textContent="-",t.title="Subtract 1 second",t.addEventListener("click",(t=>{v(u),d(h(t),-1).then((t=>e.isLive()?void 0:n(t.when)))})),p.appendChild(t);const r=document.createElement("span");r.textContent=m,e.isLive()||(r.style.cursor="pointer",r.addEventListener("click",(t=>{v(u),l(h(t),t)}))),r.addEventListener("contextmenu",(t=>{i(h(t),!0,!1,t)})),p.appendChild(r);const a=document.createElement("button");a.className=e.getButtonClass(),a.style.width="auto",a.style.display="inline-block",a.textContent="+",a.title="Add 1 second",a.addEventListener("click",(t=>{v(u),d(h(t),1).then((t=>e.isLive()?void 0:n(t.when)))})),p.appendChild(a),u.appendChild(p)}const y=u.querySelector("span.r2_marker_title")||document.createElement("span");t||(y.className="r2_marker_title",y.style.flex="1",y.style.textAlign="center",e.isLive()||(y.style.cursor="pointer",y.addEventListener("click",(t=>{v(u),l(h(t),t)}))),y.addEventListener("contextmenu",(t=>i(h(t),!1,!0,t))),u.appendChild(y)),y.textContent=o.title;const g=u.querySelector("button.r2_marker_share")||document.createElement("button");t||(g.className=e.getButtonClass(),g.style.width="auto",g.classList.add("r2_marker_share"),g.style.float="right",g.textContent="Share",g.addEventListener("click",(async t=>navigator.clipboard.writeText(await e.generateMarkerURL(h(t).when)))),u.appendChild(g));const f=u.querySelector("button.r2_marker_delete")||document.createElement("button");if(t||(f.className=e.getButtonClass(),f.style.width="auto",f.classList.add("r2_marker_delete"),f.style.float="right",f.textContent="Delete",f.addEventListener("click",(t=>{c(h(t)),u.remove()})),u.appendChild(f)),!t){const t=a.querySelector(":scope > button");t?a.insertBefore(u,t):a.appendChild(u)}}if(!r){const t=document.createElement("button");t.className=e.getButtonClass(),t.style.width="auto",t.style.float="right",t.textContent="Close",t.addEventListener("click",(()=>C(!1))),a.appendChild(t),document.body.appendChild(a),f(100).then((()=>w(a))).then((t=>{t&&(t.scrollIntoView({block:"nearest",inline:"nearest"}),v(t,!1))}))}}function S(){document.querySelector(".r2_marker_list")?.remove(),h.forEach((t=>t())),h.splice(0,h.length)}p.push(S);const C=t=>{var e;u=t,e=Number(t),s+=e,v()},E=(()=>{let t=null;const e=setInterval((()=>{const e=document.querySelector(".r2_marker_list");return e?w(e).then((e=>{e&&(g(e.style),e!==t&&(t&&(t.style.backgroundColor=""),t=e))})):null}),1e3);return p.forEach((t=>t())),()=>clearInterval(e)})();return{removeMarkerList:S,renderMarkerList:v,setMarkerList:C,uninstallMarkerList:E}})(_,a,a.getCurrentTimeLive.bind(a),N,a.seekTo.bind(a),T,D);async function N(t){for(const e of M)await e(t)}i(P.uninstallMarkerList),M.push(P.renderMarkerList);for await(const t of a.generateUniqueAttachments(_,P,N))i(t);for await(const t of a.generateMarkerChangeHandlers(_,D,T))M.push(t);async function R(t,e){let r=await a.getCurrentTimeLive();if(r+=t,e){const t=_.markers.filter((t=>Math.floor(t.when)<=r)).slice(-1)[0];t&&(t.when=r,await N(!0))}return a.seekTo(r)}async function O(t){const e=await a.getCurrentTimeLive(),r=_.markers.filter((t=>Math.floor(t.when)<=e)).slice(-1)[0];if(!r)return;let n=_.markers.indexOf(r);return n+=t,n<0&&(n=0),n>=_.markers.length&&(n=_.markers.length-1),a.seekTo(_.markers[n].when)}async function q(t){const e=await a.getCurrentTimeLive(),r=_.markers.filter((t=>Math.floor(t.when)<=e)).slice(-1)[0];return T(r,"when"===t,"title"===t)}const{addMarkerHere:B,mainMenu:z,showKeyboardShortcuts:$}=function(){const i=async()=>(await h(L().serializeAll(_.markers)),a.dialog("alert","Exported to Clipboard!")),s=async()=>{if(w=await a.getCollections(),!w.length)return o();const e=await a.dialog("choose","Import/Export",(()=>({[`Import (${w.length})`]:"i",Export:"e",Clear:"c"})));return e?"i"===e?(async()=>{const t=await a.dialog("choose","Import from...",(()=>w.reduce(((t,e)=>(t[`${e.author?`[${e.author.username}] `:""}${e.title} (${"markers"in e?e.markers.length:e.markerCount})`]=e._id,t)),{})));if(!t)return;const e=w.find((e=>e._id===t));return Object.assign(_,"WEBSITE"===e.author._id?e:await n(t)),await N(!0),C=_.updatedAt,N(!1)})():"e"===e?o():"c"===e?(async function(t){localStorage.removeItem("r2_twitch_user_markers_v2_"+t)}(_.entity._id),void l().then(t)):void 0:void 0},o=async()=>{if(!c)return i();const t=await a.dialog("choose","Destination",(()=>({Clipboard:"b",Cloud:"c"})));return t?"b"===t?i():"c"===t?(async()=>{_.author||(_.author=c),_.author?._id!==c._id&&(await a.dialog("choose",`Export your own copy of ${_.author.username}s collection?`,(()=>({Yes:"y",No:"n"}))),_.author=c);const t=await a.dialog("prompt","Collection Title",(()=>["input",_.title]));if(!t)return;_.title=t,_.description=await a.dialog("prompt","Collection Description",(()=>["textarea",_.description]));const r=await a.dialog("choose","Collection Publicity",(()=>({Public:"public",Private:"private"})));"public"===r?_.public=!0:"private"===r&&_.public&&delete _.public;const n=await async function(t){return e("/collection/"+t._id,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).catch((()=>{}))}(_);return n?(Object.assign(_,n),C=_.updatedAt,await N(!1),a.dialog("alert","Exported to Cloud!")):void 0})():void 0:void 0},d=async()=>{await a.dialog("alert","Keyboard Shortcuts:<br/>"+Object.entries({"K / Space":"Pause/Play","S / Ctrl + Left Arrow":"Seek to next marker","W / Ctrl + Right Arrow":"Seek to previous marker",J:"Seek back 10 seconds",L:"Seek forward 10 seconds","Left Arrow":"Seek back 5 seconds","Right Arrow":"Seek forward 5 seconds",",":"Seek back 1 frame",".":"Seek forward 1 frame",Q:"Seek back 1 second",E:"Seek forward 1 second",B:"Add marker at current time",N:"Edit marker title",T:"Edit marker time",U:"Open menu","Shift + ?":"Show this dialog","":"","Holding Shift + Any seek key":"Seek & update current marker"}).map((([t,e])=>`${t} -> ${e}`)).join("<br/>"))};return{addMarkerHere:async()=>{const t=!a.isLive()&&await a.isPlaying();t&&await a.pause();let e=await a.getCurrentTimeLive(),r=await a.dialog("prompt","Marker Name");if(!r)return t&&a.play();if(["t+","t-"].some((t=>r.toLowerCase().startsWith(t)))){const t="+"===r[1]?1:-1,a=parseInt(r.substring(2));isNaN(a)||(e+=a*t),r=r.substring(2+a.toString().length).trim()}const n={_id:E(),collectionRef:_._id,when:e,title:r,description:""},i=_.markers.findIndex((t=>t.when>e));return-1!==i?_.markers.splice(i,0,n):_.markers.push(n),a.isLive()&&h(await a.generateMarkerURL(e)),await N(!0),t&&a.play()},mainMenu:async()=>{const t=await a.dialog("choose","Video User Markers",(()=>({"Import/Export":"x",Edit:"e",List:"l",[c?`Logout (${c.username})`:"Login"]:"a","Share Collection":"s","Keyboard Shortcuts":"?"})));if(t)return"x"===t?s():"e"===t?A():"l"===t?P.setMarkerList(!0):"a"===t?c?c=null:(async()=>{const t=await a.dialog("prompt","Username");if(!t)return;const n=await a.dialog("prompt","Password");if(n)try{await async function(t,r){return e("/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:r})}).catch((t=>({token:null,message:t}))).then((({token:t,message:e})=>{if(e)throw new Error(e);return localStorage.setItem("r2_twitch_user_markers_v2_token",t),t}))}(t,n),c=await r()}catch(t){return a.dialog("alert",t.toString())}})():"s"===t?async function(){if(!_?.public)return a.dialog("alert","Collection must be exported to the cloud as public to be sharable");const t=`https://vum.rascaltwo.com/v/${_.entity._id}/${_._id}`;return await h(t),a.dialog("alert",`Copied URL to clipboard: <a href="${t}" target="_blank" style="display: inline-block; color: ${y()?"white":"black"};">${t}</a>`)}():"?"===t?d():void 0},showKeyboardShortcuts:d}}(),U=async t=>{const e=t.target;if(t.repeat||["INPUT","TEXTAREA"].includes(e.tagName)||"textbox"===e.getAttribute("role"))return;const r=t.key.toUpperCase();if("K"===r||" "===r)await async function(){return await a.isPlaying()?a.pause():a.play()}();else if("W"===r||t.ctrlKey&&"ARROWLEFT"===r)await O(-1);else if("S"===r||t.ctrlKey&&"ARROWRIGHT"===r)await O(1);else if("J"===r)await R(-10,t.shiftKey);else if("L"===r)await R(10,t.shiftKey);else if("ARROWLEFT"===r)await R(-5,t.shiftKey);else if("ARROWRIGHT"===r)await R(5,t.shiftKey);else if(","===r)await R(-1/30,t.shiftKey);else if("."===r)await R(1/30,t.shiftKey);else if("Q"===r)await R(-1,t.shiftKey);else if("E"===r)await R(1,t.shiftKey);else if("B"===r)await B();else if("N"===r)await q("title");else if("T"===r)await q("when");else if("U"===r)await z();else{if(!t.shiftKey||"?"!==r)return;await $()}t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation()};window.addEventListener("keypress",U),i((()=>window.removeEventListener("keypress",U))),_.markers.length&&await N(!1),m("Setup Ended")}().catch((t=>m("Error during main",t))),m("Script Ended")})();